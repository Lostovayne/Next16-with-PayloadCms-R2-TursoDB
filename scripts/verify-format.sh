#!/bin/bash

# ===================================
# Script de VerificaciÃ³n de Formato
# ===================================
# Verifica que el cÃ³digo estÃ© correctamente formateado
# y que pase todas las reglas de linting

set -e  # Exit on error

echo "ğŸ” Verificando formato y calidad de cÃ³digo..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
ERRORS=0
WARNINGS=0

# ===================================
# 1. Verificar Prettier
# ===================================
echo "ğŸ“ Verificando formato con Prettier..."
if pnpm exec prettier --check . 2>/dev/null; then
    echo -e "${GREEN}âœ… Prettier: CÃ³digo correctamente formateado${NC}"
else
    echo -e "${RED}âŒ Prettier: CÃ³digo necesita formateo${NC}"
    echo ""
    echo "   Para arreglar automÃ¡ticamente:"
    echo "   pnpm format"
    echo ""
    ((ERRORS++))
fi
echo ""

# ===================================
# 2. Verificar ESLint
# ===================================
echo "ğŸ” Verificando calidad con ESLint..."
if pnpm lint 2>/dev/null; then
    echo -e "${GREEN}âœ… ESLint: Sin errores de linting${NC}"
else
    echo -e "${RED}âŒ ESLint: Errores encontrados${NC}"
    echo ""
    echo "   Para arreglar automÃ¡ticamente:"
    echo "   pnpm lint:fix"
    echo ""
    ((ERRORS++))
fi
echo ""

# ===================================
# 3. Verificar TypeScript
# ===================================
echo "ğŸ”· Verificando tipos con TypeScript..."
if pnpm exec tsc --noEmit 2>/dev/null; then
    echo -e "${GREEN}âœ… TypeScript: Sin errores de tipado${NC}"
else
    echo -e "${RED}âŒ TypeScript: Errores de tipado encontrados${NC}"
    echo ""
    echo "   Revisa los errores arriba"
    echo ""
    ((ERRORS++))
fi
echo ""

# ===================================
# 4. Verificar archivos ignorados
# ===================================
echo "ğŸš« Verificando que archivos crÃ­ticos no fueron modificados..."

# Verificar pnpm-lock.yaml
if git diff --quiet pnpm-lock.yaml 2>/dev/null; then
    echo -e "${GREEN}âœ… pnpm-lock.yaml: Sin cambios${NC}"
else
    if [ -f pnpm-lock.yaml ]; then
        echo -e "${YELLOW}âš ï¸  pnpm-lock.yaml: Fue modificado${NC}"
        echo "   Esto es normal si agregaste/actualizaste dependencias"
        ((WARNINGS++))
    fi
fi

# Verificar payload-types.ts no tiene errores de formato
if [ -f src/payload-types.ts ]; then
    if grep -q "// This file is automatically generated" src/payload-types.ts 2>/dev/null; then
        echo -e "${GREEN}âœ… payload-types.ts: Archivo generado correctamente${NC}"
    else
        echo -e "${YELLOW}âš ï¸  payload-types.ts: Puede necesitar regeneraciÃ³n${NC}"
        echo "   Ejecuta: pnpm generate:types"
        ((WARNINGS++))
    fi
fi

echo ""

# ===================================
# 5. Verificar que semicolons estÃ©n presentes
# ===================================
echo "ğŸ” Verificando uso de semicolons..."

# Contar archivos sin semicolon al final de declaraciones
MISSING_SEMICOLONS=0

# Buscar en archivos TypeScript/JavaScript
while IFS= read -r file; do
    # Ignorar archivos que deberÃ­an tener semicolons
    if [[ "$file" == *"node_modules"* ]] || \
       [[ "$file" == *".next"* ]] || \
       [[ "$file" == *"payload-types.ts"* ]]; then
        continue
    fi

    # Buscar lÃ­neas que parecen necesitar semicolon
    # (esto es una verificaciÃ³n simple, no exhaustiva)
    if grep -qE "(const|let|var|import|export).+[^;]$" "$file" 2>/dev/null; then
        ((MISSING_SEMICOLONS++))
    fi
done < <(find src -type f \( -name "*.ts" -o -name "*.tsx" \) 2>/dev/null || true)

if [ $MISSING_SEMICOLONS -eq 0 ]; then
    echo -e "${GREEN}âœ… Semicolons: Correctamente usados${NC}"
else
    echo -e "${YELLOW}âš ï¸  Posibles semicolons faltantes en $MISSING_SEMICOLONS archivo(s)${NC}"
    echo "   Ejecuta 'pnpm format' para arreglar automÃ¡ticamente"
    ((WARNINGS++))
fi

echo ""

# ===================================
# Resumen
# ===================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š RESUMEN"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}âœ¨ Â¡Todo perfecto! CÃ³digo listo para commit${NC}"
    echo ""
    exit 0
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}âš ï¸  $WARNINGS advertencia(s) encontrada(s)${NC}"
    echo -e "${GREEN}âœ… Sin errores - CÃ³digo puede ser commiteado${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âŒ $ERRORS error(es) encontrado(s)${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}âš ï¸  $WARNINGS advertencia(s) encontrada(s)${NC}"
    fi
    echo ""
    echo "ğŸ”§ Comandos para arreglar:"
    echo "   pnpm format      # Formatear cÃ³digo"
    echo "   pnpm lint:fix    # Fix linting automÃ¡tico"
    echo ""
    exit 1
fi
